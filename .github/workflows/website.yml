name: website-deploy
on:
  push:
    branches:
      - main
  release:
    types: [published]

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for mike to work with git history

      - name: Configure Git Credentials
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: 'pyproject.toml'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: '0.5.5'
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Get version
        id: get_version
        # Uses hatch rather than ato to get the version
        # because currently ato might also produce logging output
        # which contaminates stdout
        run: |
          VERSION=$(uv run hatch version)
          MAJOR_MINOR=$(echo $VERSION | cut -d. -f1,2)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "MAJOR_MINOR=$MAJOR_MINOR" >> $GITHUB_ENV

      - name: Deploy development docs
        if: github.event_name == 'push'
        run: uv run mike deploy --push --update-aliases $MAJOR_MINOR dev

      - name: Deploy release docs
        if: github.event_name == 'release'
        run: uv run mike deploy --push --update-aliases $MAJOR_MINOR latest
