name: pytest

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

env:
  KICAD_VERSION: "9.0"

jobs:
  pytest:
    #runs-on: blacksmith-4vcpu-ubuntu-2404
    #runs-on: blacksmith-32vcpu-ubuntu-2404-arm
    #runs-on: blacksmith-16vcpu-ubuntu-2404
    runs-on: [self-hosted]
    #runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        #with:
        #  fetch-depth: 100
        #  fetch-tags: true

      - run: git fetch --prune --unshallow --tags

      - name: Prepare artifacts dir
        run: mkdir -p artifacts

      - name: Check for uv
        id: check-uv
        run: echo "has-uv=$(command -v uv >/dev/null 2>&1 && echo true || echo false)" >> "$GITHUB_OUTPUT"

      - name: Install uv + Python
        if: steps.check-uv.outputs.has-uv != 'true'
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.14"

      - name: "Install dependencies"
        run: |
          uv sync --dev --no-install-project --frozen
        env:
          UV_PYTHON: "3.14"

      - name: Compute zig cache key
        id: zig-hash
        run: |
          echo "hash=$(python src/faebryk/core/zig/compute_hash.py)" >> "$GITHUB_OUTPUT"
          echo "pyver=$(python -c 'import sys; print(f"{sys.version_info.major}.{sys.version_info.minor}.{sys.version_info.micro}")')" >> "$GITHUB_OUTPUT"

      - name: Restore zig cache
        id: zig-cache
        uses: actions/cache/restore@v4
        with:
          path: src/faebryk/core/zig/zig-out
          key: zig-${{ runner.os }}-${{ runner.arch }}-py${{ steps.zig-hash.outputs.pyver }}-${{ steps.zig-hash.outputs.hash }}

      - name: "Compile & build package"
        run: |
          uv pip install --no-deps .
        env:
          ATOPILE_ZIG_OUT_DIR: ${{ github.workspace }}/src/faebryk/core/zig/zig-out

      - name: Save zig cache
        if: steps.zig-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: src/faebryk/core/zig/zig-out
          key: zig-${{ runner.os }}-${{ runner.arch }}-py${{ steps.zig-hash.outputs.pyver }}-${{ steps.zig-hash.outputs.hash }}

      - name: Check ato version
        run: |
          git describe --tags --dirty --long; \
          .venv/bin/python -c "import importlib.metadata; print(importlib.metadata.version('atopile'))"; \
          .venv/bin/ato self-check; \
          .venv/bin/ato --version; \
          .venv/bin/ato --semver; \
        env:
          PYTHONPATH: .venv/bin/python

      - name: Run pytest
        id: pytest
        continue-on-error: true
        run: |
          echo hi
      # - name: Run pytest
      #   id: pytest
      #   continue-on-error: true
      #   # FIXME timeout
      #   # TODO consider replacing with `ato dev test --ci`
      #   run: |
      #     uv run \
      #       test/runner/main.py \
      #       -m "not not_in_ci and not slow and not regression" \
      #       --timeout=120 \
      #   env:
      #     PYTHONPATH: .
      #     GH_TOKEN: ${{ github.token }}
      #     COLUMNS: 150 # rich console width will be pulled from this
      #     FBRK_TEST_REPORT_INTERVAL: 10
      #     FBRK_TEST_LONG_THRESHOLD: 30
      #     FBRK_TEST_SHOW_PYTEST_OUTPUT: 0
      #     FBRK_TEST_WORKERS: -2 # 32 threads/16 cpus -> 32 workers
      #     FBRK_TEST_PERIODIC_HTML: 0
      #     FBRK_TEST_GENERATE_HTML: 1
      #     # threshold for worker to restart after exceeding after a test run
      #     FBRK_TEST_WORKER_MEMORY_LIMIT_MB: 1024
      #     PYTHON_UNBUFFERED: 1

      # - name: Upload test report json artifact
      #   if: always()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: test-report.json
      #     path: artifacts/test-report.json
      #     if-no-files-found: error

      # - name: Upload test report html artifact
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: test-report.html
      #     path: artifacts/test-report.html
      #     if-no-files-found: warn

      - name: Check pytest status
        if: steps.pytest.outcome == 'failure'
        run: exit 1
