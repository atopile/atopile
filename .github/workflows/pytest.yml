name: pytest

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

env:
  KICAD_VERSION: '9.0'

jobs:
  pytest:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Required due to a bug in the checkout action
    # https://github.com/actions/checkout/issues/1471
    - run: git fetch --prune --unshallow --tags

    - name: Prepare artifacts dir
      run: mkdir -p artifacts

    - name: Install uv
      uses: astral-sh/setup-uv@v6
      with:
        version: 0.8
        enable-cache: true
        cache-dependency-glob: "uv.lock"

    - name: "Set up Python"
      uses: actions/setup-python@v5
      with:
        python-version-file: "pyproject.toml"

    - name: Run pytest
      id: pytest
      continue-on-error: true
      run: >
        uv run --dev --no-editable --frozen
        --with pytest-github-actions-annotate-failures
        pytest
        -m "not not_in_ci and not slow and not regression"
        --timeout=300
        --junitxml=artifacts/junit.xml
      env:
        GH_TOKEN: ${{ github.token }}
        COLUMNS: 150  # rich console width will be pulled from this

    - name: Build single-page dashboard
      if: always()
      env:
        STATUS: ${{ steps.pytest.outcome }}
        RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
      run: |
        python - <<'PY'
        from pathlib import Path
        import os
        import xml.etree.ElementTree as ET

        artifacts = Path("artifacts")
        junit = artifacts / "junit.xml"
        artifacts.mkdir(exist_ok=True)

        passed = failed = errors = skipped = 0
        if junit.exists():
          tree = ET.parse(junit)
          root = tree.getroot()
          suites = root.findall(".//testsuite")
          if not suites and root.tag == "testsuite":
              suites = [root]
          for suite in suites:
              passed += int(suite.attrib.get("tests", 0)) - int(suite.attrib.get("failures", 0)) - int(suite.attrib.get("errors", 0)) - int(suite.attrib.get("skipped", 0))
              failed += int(suite.attrib.get("failures", 0))
              errors += int(suite.attrib.get("errors", 0))
              skipped += int(suite.attrib.get("skipped", 0))

        total = passed + failed + errors + skipped
        total = total or 1  # avoid div by zero
        segments = [
            ("Passed", passed, "#16a34a"),
            ("Failed", failed, "#dc2626"),
            ("Errors", errors, "#b91c1c"),
            ("Skipped", skipped, "#6b7280"),
        ]

        status = os.getenv("STATUS", "unknown")
        run_url = os.getenv("RUN_URL", "")

        def segment_html(label, count, color):
            pct = (count / total) * 100
            if pct <= 0:
                return ""
            return f'<div class="seg" style="width:{pct:.1f}%;background:{color}" title="{label}: {count} ({pct:.1f}%)"></div>'

        bar_html = "".join(segment_html(*s) for s in segments if s[1] > 0)
        summary_items = "".join(
            f"<li><span class='label'>{label}:</span> <span class='count'>{count}</span></li>"
            for label, count, _ in segments
        )

        html = f"""<!doctype html>
        <html lang="en">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Pytest results</title>
          <style>
            body {{ font-family: Arial, sans-serif; padding: 24px; max-width: 720px; margin: auto; color: #111827; background: #f8fafc; }}
            h1 {{ margin-bottom: 8px; }}
            .status {{ font-size: 1rem; margin-bottom: 16px; }}
            .pill {{ display: inline-block; padding: 4px 10px; border-radius: 9999px; font-weight: 600; background: #e5e7eb; }}
            .bar {{ display: flex; height: 24px; border-radius: 12px; overflow: hidden; background: #e5e7eb; box-shadow: inset 0 1px 2px rgba(0,0,0,0.08); }}
            .seg {{ height: 100%; }}
            ul {{ list-style: none; padding: 0; margin: 12px 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px; }}
            li {{ background: white; border-radius: 10px; padding: 10px 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }}
            .label {{ color: #4b5563; }}
            .count {{ font-weight: 700; float: right; }}
            .meta a {{ color: #2563eb; text-decoration: none; }}
          </style>
        </head>
        <body>
          <h1>Pytest results</h1>
          <div class="status">Run status: <span class="pill">{status}</span></div>
          <div class="bar">{bar_html or '<div class="seg" style="width:100%;background:#e5e7eb"></div>'}</div>
          <ul>{summary_items}</ul>
          <div class="meta">Run: <a href="{run_url}">{run_url}</a></div>
        </body>
        </html>
        """

        (artifacts / "dashboard.html").write_text(html, encoding="utf-8")
        PY

    - name: Upload dashboard artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pytest-dashboard
        path: artifacts/dashboard.html
        if-no-files-found: error

    - name: Upload all test logs
      if: steps.pytest.outcome == 'failure'
      uses: actions/upload-artifact@v4
      with:
        name: test-logs
        path: artifacts/**/*.log
        if-no-files-found: warn

    - name: Upload all test report
      if: steps.pytest.outcome == 'failure'
      uses: actions/upload-artifact@v4
      with:
        name: test-report
        path: artifacts/test-report.html

    - name: Check pytest status
      if: steps.pytest.outcome == 'failure'
      run: exit 1
