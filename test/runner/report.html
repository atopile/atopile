<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Test Execution Report</title>
    <style>
        /* Catppuccin Mocha Palette */
        :root {{
            --ctp-rosewater: #f5e0dc;
            --ctp-flamingo: #f2cdcd;
            --ctp-pink: #f5c2e7;
            --ctp-mauve: #cba6f7;
            --ctp-red: #f38ba8;
            --ctp-maroon: #eba0ac;
            --ctp-peach: #fab387;
            --ctp-yellow: #f9e2af;
            --ctp-green: #a6e3a1;
            --ctp-teal: #94e2d5;
            --ctp-sky: #89dceb;
            --ctp-sapphire: #74c7ec;
            --ctp-blue: #89b4fa;
            --ctp-lavender: #b4befe;
            --ctp-text: #cdd6f4;
            --ctp-subtext1: #bac2de;
            --ctp-subtext0: #a6adc8;
            --ctp-overlay2: #9399b2;
            --ctp-overlay1: #7f849c;
            --ctp-overlay0: #6c7086;
            --ctp-surface2: #585b70;
            --ctp-surface1: #45475a;
            --ctp-surface0: #313244;
            --ctp-base: #1e1e2e;
            --ctp-mantle: #181825;
            --ctp-crust: #11111b;
        }}

        html {{ font-size: 12px; }}
        body {{ font-family: sans-serif; margin: 10px; background-color: var(--ctp-base); color: var(--ctp-text); }}
        h1 {{ font-size: 1.5rem; margin-bottom: 10px; color: var(--ctp-text); }}
        .summary {{ margin-bottom: 10px; padding: 8px; background: var(--ctp-mantle); border-radius: 5px; border: 1px solid var(--ctp-surface0); }}
        .progress-bar {{ width: 100%; background-color: var(--ctp-surface0); border-radius: 5px; overflow: hidden; height: 15px; margin-bottom: 10px;}}
        .progress-fill {{ height: 100%; background-color: var(--ctp-green); transition: width 0.5s; text-align: center; color: var(--ctp-crust); line-height: 15px; font-size: 10px; font-weight: bold; }}
        table {{ border-collapse: collapse; width: 100%; font-size: 12px; }}
        th, td {{ border: 1px solid var(--ctp-surface0); padding: 4px; text-align: left; }}
        th {{ background-color: var(--ctp-mantle); cursor: pointer; user-select: none; position: relative; color: var(--ctp-subtext1); }}
        th:hover {{ background-color: var(--ctp-surface0); }}
        .passed {{ color: var(--ctp-green); }}
        .failed {{ color: var(--ctp-red); font-weight: bold; }}
        .error {{ color: var(--ctp-maroon); font-weight: bold; }}
        .crashed {{ color: var(--ctp-mauve); font-weight: bold; text-transform: uppercase; }}
        .skipped {{ color: var(--ctp-yellow); }}
        .running {{ color: var(--ctp-blue); }}
        .queued {{ color: var(--ctp-overlay1); font-style: italic; }}
        tr.row-passed {{ background-color: rgba(166, 227, 161, 0.1); }}
        tr.row-failed {{ background-color: rgba(243, 139, 168, 0.15); }}
        tr.row-error {{ background-color: rgba(235, 160, 172, 0.15); }}
        tr.row-crashed {{ background-color: rgba(203, 166, 247, 0.15); }}
        tr.row-skipped {{ background-color: rgba(249, 226, 175, 0.1); }}
        tr.row-running {{ background-color: rgba(137, 180, 250, 0.15); }}
        tr.row-queued {{ background-color: var(--ctp-mantle); }}
        tr:hover {{ background-color: var(--ctp-surface0); }}
        .controls {{ margin-bottom: 5px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }}
        .filter-input {{ padding: 3px; width: 200px; background-color: var(--ctp-surface0); border: 1px solid var(--ctp-surface1); color: var(--ctp-text); border-radius: 3px; }}
        .filter-input::placeholder {{ color: var(--ctp-overlay0); }}
        .filter-input:focus {{ outline: none; border-color: var(--ctp-lavender); }}
        .outcome-filters {{ display: flex; gap: 5px; }}
        .outcome-filters label {{ cursor: pointer; color: var(--ctp-subtext0); }}
        
        .sort-indicator {{ margin-left: 5px; }}
        
        .log-match {{ 
            background-color: var(--ctp-yellow); 
            color: var(--ctp-crust);
            font-weight: bold;
        }}
        
        .error-cell {{
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 11px;
            color: var(--ctp-red);
        }}
        
        /* Modal styles */
        .modal {{ display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(17, 17, 27, 0.8); }}
        .modal-content {{ background-color: var(--ctp-mantle); margin: 5% auto; padding: 15px; border: 1px solid var(--ctp-surface1); width: 90%; max-height: 85vh; overflow-y: auto; border-radius: 8px; }}
        .close {{ color: var(--ctp-overlay1); float: right; font-size: 24px; font-weight: bold; cursor: pointer; }}
        .close:hover, .close:focus {{ color: var(--ctp-text); text-decoration: none; cursor: pointer; }}
        pre {{ background: var(--ctp-crust); padding: 8px; overflow-x: auto; white-space: pre-wrap; font-size: 11px; color: var(--ctp-text); border-radius: 4px; border: 1px solid var(--ctp-surface0); }}
        button {{ font-size: 11px; padding: 2px 8px; background-color: var(--ctp-surface0); color: var(--ctp-text); border: 1px solid var(--ctp-surface1); border-radius: 3px; cursor: pointer; }}
        button:hover {{ background-color: var(--ctp-surface1); }}
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {{ width: 8px; height: 8px; }}
        ::-webkit-scrollbar-track {{ background: var(--ctp-mantle); }}
        ::-webkit-scrollbar-thumb {{ background: var(--ctp-surface1); border-radius: 4px; }}
        ::-webkit-scrollbar-thumb:hover {{ background: var(--ctp-surface2); }}
        
        /* Links */
        a {{ color: var(--ctp-blue); }}
        a:hover {{ color: var(--ctp-sky); }}
        
        /* Code elements */
        code {{ background-color: var(--ctp-surface0); padding: 2px 4px; border-radius: 3px; color: var(--ctp-peach); }}
        
        /* Strong/bold text */
        strong {{ color: var(--ctp-text); }}
        
        /* Emphasis */
        em {{ color: var(--ctp-subtext0); }}

        /* Checkbox styling */
        input[type="checkbox"] {{
            accent-color: var(--ctp-lavender);
        }}
    </style>
    <script>
        var currentSortColumn = -1;
        var currentSortDir = "asc";

        document.addEventListener('DOMContentLoaded', function() {{
            document.querySelectorAll('.outcome-filter').forEach(cb => {{
                cb.addEventListener('change', filterTable);
            }});
            
            // Start polling if running
            setInterval(checkAndReload, 2000);
        }});

        async function checkAndReload() {{
            // Don't reload if any modal is open
            if (document.querySelector('.modal[style*="block"]')) return;

            var statusElement = document.getElementById("status-text");
            if (!statusElement) return;
            var statusText = statusElement.innerText;
            if (!statusText.includes("Running")) return;
            
            try {{
                var url = window.location.href.split('?')[0] + '?t=' + new Date().getTime();
                var response = await fetch(url);
                var text = await response.text();
                var parser = new DOMParser();
                var doc = parser.parseFromString(text, 'text/html');
                
                // Update Summary
                var newSummary = doc.querySelector('.summary');
                if (newSummary) document.querySelector('.summary').innerHTML = newSummary.innerHTML;
                
                // Update Progress
                var newProgress = doc.querySelector('.progress-bar');
                if (newProgress) document.querySelector('.progress-bar').innerHTML = newProgress.innerHTML;
                
                // Update Timestamp
                var newTimestamp = doc.getElementById("timestamp");
                if (newTimestamp) document.getElementById("timestamp").innerText = newTimestamp.innerText;

                // Update Table Body
                var newTbody = doc.querySelector('#testTable tbody');
                if (newTbody) {{
                    document.querySelector('#testTable tbody').innerHTML = newTbody.innerHTML;
                    
                    // Re-apply filter
                    filterTable();
                    
                    // Re-apply sort if active
                    if (currentSortColumn !== -1) {{
                        sortGrid(currentSortColumn, currentSortDir);
                    }}
                }}
            }} catch (e) {{
                console.error("Failed to reload", e);
            }}
        }}

        function filterTable() {{
            var input, filter, table, tr, td, i, txtValue;
            input = document.getElementById("searchInput");
            filter = input.value.toUpperCase();
            
            var logInput = document.getElementById("logSearchInput");
            var logFilter = logInput.value.toUpperCase();

            table = document.getElementById("testTable");
            // Get all rows from tbody
            var tbody = table.getElementsByTagName("tbody")[0];
            tr = tbody.getElementsByTagName("tr");
            
            var checkedOutcomes = Array.from(document.querySelectorAll('.outcome-filter:checked')).map(cb => cb.value);

            for (i = 0; i < tr.length; i++) {{
                var visible = false;
                
                var textMatch = false;
                if (filter === "") {{
                    textMatch = true;
                }} else {{
                    // Search in File(0), Test(1), Subtest(2), Params(3)
                    for (var j = 0; j < 4; j++) {{
                        td = tr[i].getElementsByTagName("td")[j];
                        if (td) {{
                            txtValue = td.textContent || td.innerText;
                            if (txtValue.toUpperCase().indexOf(filter) > -1) {{
                                textMatch = true;
                                break;
                            }}
                        }}
                    }}
                }}

                var logMatch = false;
                var logButton = tr[i].querySelector("button");
                
                if (logFilter === "") {{
                    logMatch = true;
                    if (logButton) logButton.classList.remove("log-match");
                }} else {{
                    // Logs are in the modal div inside the row
                    var modalDiv = tr[i].querySelector(".modal-content");
                    if (modalDiv) {{
                        var logText = modalDiv.textContent || modalDiv.innerText;
                        if (logText.toUpperCase().indexOf(logFilter) > -1) {{
                            logMatch = true;
                            if (logButton) logButton.classList.add("log-match");
                        }} else {{
                            if (logButton) logButton.classList.remove("log-match");
                        }}
                    }} else {{
                        logMatch = false;
                    }}
                }}

                var outcomeMatch = false;
                // Outcome is now column 4
                td = tr[i].getElementsByTagName("td")[4];
                if (td) {{
                    var outcomeClass = td.className; 
                    if (checkedOutcomes.includes(outcomeClass)) {{
                        outcomeMatch = true;
                    }}
                }}
                
                if (textMatch && outcomeMatch && logMatch) {{
                    tr[i].style.display = "";
                }} else {{
                    tr[i].style.display = "none";
                }}
            }}
        }}
        
        function sortTable(n) {{
            var dir = "asc"; 
            if (currentSortColumn === n && currentSortDir === "asc") {{
                dir = "desc";
            }}
            currentSortColumn = n;
            currentSortDir = dir;
            sortGrid(n, dir);
        }}

        function sortGrid(n, dir) {{
            var table = document.getElementById("testTable");
            var tbody = table.getElementsByTagName("tbody")[0];
            var rows = Array.from(tbody.getElementsByTagName("tr"));
            
            rows.sort(function(rowA, rowB) {{
                var x = rowA.getElementsByTagName("TD")[n];
                var y = rowB.getElementsByTagName("TD")[n];
                
                var xVal = x.textContent.toLowerCase().trim();
                var yVal = y.textContent.toLowerCase().trim();
                
                // Numeric sort for Duration (column 5), Memory (column 6), and Peak Memory (column 7)
                if (n === 5 || n === 6 || n === 7) {{
                    // Use data-value attribute if present, otherwise parse text
                    var xAttr = x.getAttribute("data-value");
                    var yAttr = y.getAttribute("data-value");
                    
                    var xNum = xAttr ? parseFloat(xAttr) : (parseFloat(xVal) || 0);
                    var yNum = yAttr ? parseFloat(yAttr) : (parseFloat(yVal) || 0);
                    return (dir === "asc") ? (xNum - yNum) : (yNum - xNum);
                }}
                
                if (xVal < yVal) return (dir === "asc" ? -1 : 1);
                if (xVal > yVal) return (dir === "asc" ? 1 : -1);
                return 0;
            }});
            
            var fragment = document.createDocumentFragment();
            rows.forEach(function(row) {{
                fragment.appendChild(row);
            }});
            tbody.appendChild(fragment);
            
            var headers = table.getElementsByTagName("th");
            for (var j = 0; j < headers.length; j++) {{
                var text = headers[j].innerText.replace(" ▲", "").replace(" ▼", "");
                headers[j].innerText = text;
            }}
            if (n < headers.length) {{
                headers[n].innerText += (dir === "asc" ? " ▲" : " ▼");
            }}
        }}

        function openModal(id) {{
            document.getElementById(id).style.display = "block";
        }}
        
        function closeModal(id) {{
            document.getElementById(id).style.display = "none";
        }}
        
        window.onclick = function(event) {{
            if (event.target.className == "modal") {{
                event.target.style.display = "none";
            }}
        }}
    </script>
</head>
<body>
    <h1>Test Execution Report</h1>
    
    <div class="summary">
        <span id="status-text"><strong>Status:</strong> {status}</span> <br>
        <strong>Workers:</strong> {workers_active} active / {workers_total} total <br>
        <strong>Duration:</strong> {total_duration} <br>
        <strong>Sum Duration:</strong> {total_summed_duration} <br>
        <strong>Total Memory:</strong> {total_memory} <br>
        <strong>Passed:</strong> <span class="passed">{passed}</span> | 
        <strong>Failed:</strong> <span class="failed">{failed}</span> | 
        <strong>Errors:</strong> <span class="error">{errors}</span> | 
        <strong>Crashed:</strong> <span class="crashed">{crashed}</span> | 
        <strong>Skipped:</strong> <span class="skipped">{skipped}</span> |
        <strong>Running:</strong> <span class="running">{running}</span> |
        <strong>Queued:</strong> <span class="queued">{remaining}</span>
        {commit_info_html}
        {ci_info_html}
    </div>

    <div class="progress-bar">
        <div class="progress-fill" style="width: {progress_percent}%;">{progress_percent}%</div>
    </div>

    <div class="controls">
        <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Search..." class="filter-input">
        <input type="text" id="logSearchInput" onkeyup="filterTable()" placeholder="Search logs..." class="filter-input">
        <div class="outcome-filters">
            <label><input type="checkbox" class="outcome-filter" value="passed" checked> Passed</label>
            <label><input type="checkbox" class="outcome-filter" value="failed" checked> Failed</label>
            <label><input type="checkbox" class="outcome-filter" value="error" checked> Error</label>
            <label><input type="checkbox" class="outcome-filter" value="crashed" checked> Crashed</label>
            <label><input type="checkbox" class="outcome-filter" value="skipped" checked> Skipped</label>
            <label><input type="checkbox" class="outcome-filter" value="running" checked> Running</label>
            <label><input type="checkbox" class="outcome-filter" value="queued" checked> Queued</label>
        </div>
    </div>

    <table id="testTable">
        <thead>
            <tr>
                <th onclick="sortTable(0)">File</th>
                <th onclick="sortTable(1)">Class</th>
                <th onclick="sortTable(2)">Function</th>
                <th onclick="sortTable(3)">Params</th>
                <th onclick="sortTable(4)">Outcome</th>
                <th onclick="sortTable(5)">Duration</th>
                <th onclick="sortTable(6)">Memory</th>
                <th onclick="sortTable(7)">Peak Mem</th>
                <th onclick="sortTable(8)">Error</th>
                <th>Logs</th>
            </tr>
        </thead>
        <tbody>
            {rows}
        </tbody>
    </table>
    
    <p><em id="timestamp">Generated at {timestamp}</em></p>
</body>
</html>