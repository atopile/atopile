# Local development setup for atopile Web IDE
#
# Usage:
#   cd web-ide
#   docker compose up --build
#
# Access at: http://localhost:3000

services:
  atopile-web-ide:
    build:
      context: ..
      dockerfile: web-ide/Dockerfile
      args:
        OPENVSCODE_VERSION: "1.105.1"
        KICAD_VERSION: "9.0.7"
        ATOPILE_VERSION: "0.0.0dev"
    image: atopile-web-ide:dev
    container_name: atopile-web-ide
    ports:
      - "3000:3000"
      # Port 3000 is Caddy (reverse proxy). It routes /ws/* to the backend
      # (8501) and everything else to OpenVSCode Server (3001).
      # Ports 3001, 6080 (VNC), and 8501 (backend) are internal only.
    # Note: read_only: true is not used because the entrypoint needs to write
    # KiCad config (~/.config/kicad) and the uv tools live at ~/.local/share/uv.
    # For production, use Docker --pids-limit, --memory, --cpus, and network
    # policies for additional isolation.
    volumes:
      # Persist workspace between restarts (seeded by entrypoint on first run)
      - workspace-data:/home/openvscode-server/workspace
      # Persist VS Code user data between restarts (runtime data dir is under HOME)
      - vscode-user-data:/home/openvscode-server/.openvscode-server/data/User
    environment:
      - OPENVSCODE_SERVER_ROOT=/home/.openvscode-server
    restart: unless-stopped

volumes:
  workspace-data:
  vscode-user-data:
